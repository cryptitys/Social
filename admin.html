<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Echo — Admin (cryptitys)</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .admin-wrap{max-width:1100px;margin:22px auto;display:grid;grid-template-columns:1fr 340px;gap:18px}
    .list{max-height:560px;overflow:auto}
    .user-line{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .danger{background:#2f0b0c;color:#ffd6d6}
    .log-area{max-height:220px;overflow:auto;padding:8px;background:rgba(255,255,255,0.01);border-radius:8px}
  </style>
</head>
<body>
  <div style="padding:20px;">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div>
        <h2>Admin Panel — Echo</h2>
        <div class="small">Criador: cryptitys</div>
      </div>
      <div>
        <button class="btn btn-primary" id="btn-admin-login">Entrar como admin</button>
      </div>
    </header>

    <div class="admin-wrap">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Usuários</div>
          <div class="small">Ações</div>
        </div>
        <div id="admin-users" class="list"></div>
      </div>

      <aside>
        <div class="card" style="margin-bottom:12px">
          <div style="font-weight:700;margin-bottom:8px">Ações rápidas</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button id="btn-refresh" class="btn">Atualizar</button>
            <button id="btn-export-db" class="btn">Exportar DB</button>
            <button id="btn-clear-posts" class="btn btn-ghost">Remover todos posts (teste)</button>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">Logs</div>
          <div id="admin-logs" class="log-area"></div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // admin uses same DB key as site
    const DB_KEY = 'echo_v3_full';
    function loadDB(){try{return JSON.parse(localStorage.getItem(DB_KEY))||{users:[],posts:[]}}catch(e){return {users:[],posts:[]}}}
    function saveDB(db){localStorage.setItem(DB_KEY, JSON.stringify(db));}
    let DB = loadDB();
    let adminSession = null;

    function renderUsers(){
      DB = loadDB();
      const root = document.getElementById('admin-users');
      if(!DB.users || DB.users.length===0) { root.innerHTML = '<div class="small">Sem usuários</div>'; return; }
      root.innerHTML = DB.users.map(u => `
        <div class="user-line">
          <div>
            <div style="font-weight:700">${u.username} ${u.isAdmin?'<span style="color:var(--accent1)">(admin)</span>':''}</div>
            <div class="small">${u.banned?'<span style="color:#ff9c9c">banido</span>':'ativo'} · ${new Date(u.createdAt||Date.now()).toLocaleString()}</div>
          </div>
          <div style="display:flex;gap:6px">
            ${u.isAdmin? '' : `<button class="btn" data-act="promote" data-user="${u.username}">Promover</button>`}
            ${u.banned? `<button class="btn" data-act="unban" data-user="${u.username}">Desbanir</button>` : `<button class="btn danger" data-act="ban" data-user="${u.username}">Banir</button>`}
            <button class="btn" data-act="delete" data-user="${u.username}">Excluir</button>
          </div>
        </div>
      `).join('');
      // attach
      root.querySelectorAll('[data-act]').forEach(b => b.onclick = (ev) => {
        const act = b.dataset.act; const user = b.dataset.user;
        if(!adminSession) return alert('Faça login como admin');
        if(act === 'promote') { const u = DB.users.find(x=>x.username===user); u.isAdmin=true; saveDB(DB); log(`Promoveu ${user}`); renderUsers(); }
        if(act === 'ban') { if(!confirm('Confirmar ban?')) return; const u = DB.users.find(x=>x.username===user); u.banned=true; DB.posts = DB.posts.filter(p=>p.username!==user); saveDB(DB); log(`Baniu ${user}`); renderUsers(); }
        if(act === 'unban') { const u = DB.users.find(x=>x.username===user); u.banned=false; saveDB(DB); log(`Desbaniu ${user}`); renderUsers(); }
        if(act === 'delete') { if(!confirm('Excluir usuário e posts?')) return; DB.users = DB.users.filter(x=>x.username!==user); DB.posts = DB.posts.filter(p=>p.username!==user); saveDB(DB); log(`Excluiu ${user}`); renderUsers(); }
      });
    }

    function log(msg){ const l = document.getElementById('admin-logs'); const el = document.createElement('div'); el.textContent = `${new Date().toLocaleString()} - ${msg}`; l.prepend(el); }

    document.getElementById('btn-admin-login').onclick = () => {
      const user = prompt('Usuário admin:'); const pass = prompt('Senha:');
      if(!user||!pass) return;
      DB = loadDB();
      const u = DB.users.find(x=>x.username===user && x.password===pass);
      if(!u) return alert('Credenciais inválidas');
      if(!u.isAdmin) return alert('Somente admin');
      adminSession = u.username; alert('Logado como admin: ' + adminSession); log('Login admin: '+adminSession);
      renderUsers();
    };

    document.getElementById('btn-refresh').onclick = () => { renderUsers(); log('Refresh'); };
    document.getElementById('btn-export-db').onclick = () => {
      DB = loadDB(); const blob = new Blob([JSON.stringify(DB, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'echo_db_admin_export.json'; a.click(); URL.revokeObjectURL(url); log('Exportado DB');
    };
    document.getElementById('btn-clear-posts').onclick = () => {
      if(!confirm('Remover todos os posts (apenas teste)?')) return;
      DB = loadDB(); DB.posts = []; saveDB(DB); log('Todos posts removidos'); renderUsers();
    };

    // init
    renderUsers();
  </script>
</body>
</html>
